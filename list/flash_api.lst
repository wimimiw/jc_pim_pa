C51 COMPILER V7.06   FLASH_API                                                             12/02/2005 13:11:58 PAGE 1   


C51 COMPILER V7.06, COMPILATION OF MODULE FLASH_API
OBJECT MODULE PLACED IN .\OUTPUT\flash_api.obj
COMPILER INVOKED BY: C:\Keil\C51\BIN\C51.EXE drive\flash_api.c BROWSE INCDIR(.\APP;.\drive;.\LPC900) DEBUG OBJECTEXTEND 
                    -PRINT(.\list\flash_api.lst) OBJECT(.\OUTPUT\flash_api.obj)

stmt level    source

   1          /*C**************************************************************************
   2          * NAME:         flash_api.c
   3          *----------------------------------------------------------------------------
   4          * Copyright (c) 2002 Atmel.
   5          *----------------------------------------------------------------------------
   6          * RELEASE:      rd2-fa-uart-1_0_0      
   7          * REVISION:     1.2     
   8          *----------------------------------------------------------------------------
   9          * PURPOSE: 
  10          * Read/Write flash
  11          *****************************************************************************/
  12          
  13          /*_____ I N C L U D E - F I L E S ____________________________________________*/
  14          #include "flash_config.h"
  15          #include <reg931.h>
  16          
  17          /*_____ G L O B A L S ________________________________________________________*/
  18          
  19          
  20          /*_____ P R I V A T E - F U N C T I O N S - D E C L A R A T I O N ____________*/
  21          
  22          
  23          /*_____ L O C A L S __________________________________________________________*/
  24          
  25          #define MSK_AUXR1_ENBOOT        0x20
  26          #define MSK_AUXR_M0                             0x20
  27          #define MAP_BOOT                        AUXR1 |= MSK_AUXR1_ENBOOT;
  28          #define UNMAP_BOOT              AUXR1 &= ~MSK_AUXR1_ENBOOT;
  29          
  30          
  31          /*_____ EXTERNAL - F U N C T I O N S - D E C L A R A T I O N ____________*/
  32          
  33          extern void ASM_MOV_R1_A(void);
  34          extern void __API_FLASH_ENTRY_POINT(void);
  35          #define __API_JMP_BOOTLOADER (*((const void(code*)(void)) 0xF800 ))
  36          
  37          /*F**************************************************************************
  38          * NAME: __api_wr_code_byte 
  39          *----------------------------------------------------------------------------
  40          * PARAMS:  
  41          *               Uint16 address : address to program   
  42          *               Uchar value : data to write
  43          *               Uchar return : 
  44          *             return  = 0x00 -> pass                            
  45          *             return != 0x00 -> fail
  46          *----------------------------------------------------------------------------
  47          * PURPOSE: 
  48          *  Program data byte in Flash memory 
  49          *****************************************************************************/
  50          #ifdef __API_WR_CODE_BYTE
              Uchar __api_wr_code_byte (Uint16 address, Uchar value) small
              {
                bit ea_save;
              
C51 COMPILER V7.06   FLASH_API                                                             12/02/2005 13:11:58 PAGE 2   

                ea_save = EA;
                EA = 0;
                DPTR = address;    
                ACC = 0x02;
                ASM_MOV_R1_A();
                ACC = value;  
                      MAP_BOOT;
                __API_FLASH_ENTRY_POINT();
                      UNMAP_BOOT;
                EA = ea_save;         // restore interrupt state
                return (ACC); 
              
              }
              #endif
  69          
  70          /*F**************************************************************************
  71          * NAME: __api_wr_code_page 
  72          *----------------------------------------------------------------------------
  73          * PARAMS:  
  74          *               Uint16 add_flash : address of the first byte to program in the Flash
  75          *               Uint16 add_xram  : address in XRAM of the first data to program
  76          *               Uchar nb_data : number of bytes to program
  77          *                       Uchar return : 
  78          *           return = 0x00 -> pass                           
  79          *           return != 0x00 -> fail 
  80          *----------------------------------------------------------------------------
  81          * PURPOSE: 
  82          *  Program until 128 Datas in Flash memory.
  83          * Number of bytes to program is limited such as the Flash write remains in a
  84          * single 128 bytes page.               
  85          *****************************************************************************/
  86          #ifdef __API_WR_CODE_PAGE
              Uchar __api_wr_code_page (Uint16 add_flash, Uint16 add_xram, Uchar nb_data) small
              {
                      Uchar save_auxr1;
              
                bit ea_save;
              
                ea_save = EA;
                EA = 0;
                      save_auxr1 = AUXR1;
                      
                AUXR1 &= ~0x01;               // Set DPTR     =       DPTR0
                DPTR = add_flash;
                AUXR1++;                                      // DPTR = DPTR1
                DPTR = add_xram;
                ACC = 0x09;
                ASM_MOV_R1_A();
                ACC = nb_data;
                      AUXR1 &= ~0x01;         // Set DPTR = DPTR0
                      MAP_BOOT
                __API_FLASH_ENTRY_POINT();
                      UNMAP_BOOT;
                AUXR1 = save_auxr1;                   
                EA = ea_save;         // restore interrupt state
              return (ACC);
              
              }
              #endif
 114          
 115          
 116          /*F**************************************************************************
C51 COMPILER V7.06   FLASH_API                                                             12/02/2005 13:11:58 PAGE 3   

 117          * NAME: __api_fct_set_1 
 118          *----------------------------------------------------------------------------
 119          * PARAMS:  
 120          *               Uchar _R1 : 
 121          *               Uint16 _DPTR : 
 122          *                       Uchar return : 
 123          *----------------------------------------------------------------------------
 124          * PURPOSE: 
 125          * Common function for API access in the bootloader
 126          *****************************************************************************/
 127          #ifdef __API_FCT_SET_1
              Uchar __api_fct_set_1 (Uchar _R1, Uint16 _DPTR) small
              {
                bit ea_save;
              
                ea_save = EA;
                EA = 0;
                DPTR  = _DPTR;
                ACC   = _R1;
                ASM_MOV_R1_A();
                      MAP_BOOT;
                __API_FLASH_ENTRY_POINT();
                      UNMAP_BOOT;
                EA = ea_save;         // restore interrupt state
                return (ACC);
              
              }
              #endif
 145          
 146          
 147          /*F**************************************************************************
 148          * NAME: __api_fct_set_2
 149          *----------------------------------------------------------------------------
 150          * PARAMS:  
 151          *               Uchar _ACC : 
 152          *               Uchar _DPL : 
 153          *                       Uchar return : 
 154          *----------------------------------------------------------------------------
 155          * PURPOSE: 
 156          * Common function for API access in the bootloader
 157          *****************************************************************************/
 158          #ifdef __API_FCT_SET_2
 159          Uchar __api_fct_set_2 (Uchar _ACC, Uchar _DPL) small
 160          {
 161   1        bit ea_save;
 162   1      
 163   1        ea_save = EA;
 164   1        EA = 0;
 165   1        DPH = 0x00;
 166   1        DPL = _DPL;
 167   1        ACC = 0x06;
 168   1        ASM_MOV_R1_A();
 169   1        ACC = _ACC;
 170   1              MAP_BOOT;
 171   1        __API_FLASH_ENTRY_POINT();
 172   1              UNMAP_BOOT;
 173   1        EA = ea_save;         // restore interrupt state
 174   1        return 1;
 175   1      }
 176          #endif
 177          
 178          /*F**************************************************************************
C51 COMPILER V7.06   FLASH_API                                                             12/02/2005 13:11:58 PAGE 4   

 179          * NAME: __api_fct_set_3
 180          *----------------------------------------------------------------------------
 181          * PARAMS:  
 182          *               Uchar _ACC : 
 183          *               Uchar _DPL : 
 184          *                       Uchar return : 
 185          *----------------------------------------------------------------------------
 186          * PURPOSE: 
 187          * Common function for API access in the bootloader
 188          *****************************************************************************/
 189          #ifdef __API_FCT_SET_3
              Uchar __api_fct_set_3 (Uchar _ACC, Uchar _DPL) small
              {
                bit ea_save;
              
                ea_save = EA;
                EA = 0;
                DPH = 0x00;
                DPL = _DPL;
                ACC = 0x0A;
                ASM_MOV_R1_A();
                ACC = _ACC;
                      MAP_BOOT;
                __API_FLASH_ENTRY_POINT();
                      UNMAP_BOOT;
                EA = ea_save;         // restore interrupt state
                return 1;
              }
              #endif
 208          
 209          
 210          /*F**************************************************************************
 211          * NAME: api_start_bootloader                                            
 212          *----------------------------------------------------------------------------
 213          * PARAMS:  
 214          * return: 
 215          *----------------------------------------------------------------------------
 216          * PURPOSE: 
 217          *****************************************************************************
 218          * NOTE: 
 219          * To use this function the constante __API_START_BOOTLOADER must be define in
 220          * C header file.
 221          *****************************************************************************/
 222          #ifdef __API_START_BOOTLOADER
              void __api_start_bootloader (void)
              {
                      __api_wr_BSB (0xFF);
                      __api_wr_SBV (0xFC);
                      // stop application peripherals 
                      T2CON=0x00;
                      TL2=0x00;
                      TH2=0x00;
                      BDRCON=0x00;
                      TCON=0x00;
                      SCON = 0x00;
                      TMOD = 0x00;
                      PCON = 0x00;
                      TCON = 0x00;
                      EA = 0;
                      MAP_BOOT;
                      __API_JMP_BOOTLOADER();
              }
C51 COMPILER V7.06   FLASH_API                                                             12/02/2005 13:11:58 PAGE 5   

              #endif
 242          
 243          
 244          
 245          
 246          
 247          
 248          
 249          
 250          
 251          
 252          
 253          
 254          
 255          
 256          
 257          
 258          
 259          
 260          
 261          
 262          
 263          
 264          
 265          
 266          
 267          
 268          
 269          
 270          
 271          
 272          
 273          
 274          
 275          
 276          
 277          
 278          
 279          
 280          
 281          
 282          
 283          
 284          
 285          
 286          
 287          
 288          
 289          
 290          
 291          
 292          
 293          
 294          
 295          
 296          
 297          
 298          
 299          
 300          
 301          
 302          
C51 COMPILER V7.06   FLASH_API                                                             12/02/2005 13:11:58 PAGE 6   

 303          
 304          
 305          
 306          
 307          
 308          
 309          
 310          
 311          
 312          
 313          
 314          
 315          
 316          
 317          
 318          
 319          
 320          
 321          
 322          
 323          
 324          
 325          
 326          
 327          
 328          


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =     36    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----       1
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----       1
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
